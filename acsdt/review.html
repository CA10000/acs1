<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è§£æå›çœ‹</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Segoe UI,Helvetica,Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333}
    .container{max-width:900px;margin:0 auto;padding:20px}
    header{text-align:center;color:#fff;margin-bottom:30px}
    .section{background:#fff;border-radius:12px;padding:25px;margin-bottom:20px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
    .review-card{margin-bottom:15px;padding:15px;border-left:5px solid #28a745;background:#f8f9fa;border-radius:8px}
    .review-card.wrong{border-left-color:#dc3545;background:#fff6f6}
    .your-ans{font-weight:bold;margin:8px 0}
    .exp{background:#e3f2fd;padding:10px;border-radius:6px;margin-top:8px}
    .options-list{margin-top:8px}
    .options-list li{padding:6px 8px;border-radius:6px;margin-bottom:6px;list-style:none;background:#fff}
    .options-list li.correct{background:#e6ffed;border:1px solid #c3f0c8}
    .options-list li.selected{box-shadow:inset 0 0 0 2px rgba(102,126,234,.12)}
    .no-data{text-align:center;padding:30px;color:#666}
    .btn{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;margin:5px;transition:all .3s}
    .btn-primary{background:#667eea;color:#fff}
    .btn-secondary{background:#6c757d;color:#fff}
    .btn-success{background:#28a745;color:#fff}
    .result-actions{text-align:center;margin-top:20px}
    .meta{margin-bottom:12px;color:#444}
  </style>
</head>
<body>
  <div class="container">
    <header><h1>ğŸ“– è§£æå›çœ‹</h1></header>
    <section class="section">
      <div class="meta">
        å…± <span id="rev-total">0</span> é¢˜ï¼Œç­”å¯¹ <span id="rev-correct">0</span> é¢˜ï¼Œæ­£ç¡®ç‡ <span id="rev-rate">0</span>%
      </div>
      <div id="review-box"></div>
      <div class="result-actions">
        <button id="btn-back" class="btn btn-primary" onclick="location.href='index.html'">è¿”å›ç­”é¢˜</button>
        <button id="btn-wrong" class="btn btn-secondary" onclick="toggleWrong()">åªçœ‹é”™é¢˜</button>
        <button id="btn-export" class="btn btn-success" onclick="exportReview()">å¯¼å‡º txt</button>
      </div>
    </section>
  </div>

<script>
const questions = JSON.parse(sessionStorage.getItem('reviewQuestions') || '[]');
const answers   = JSON.parse(sessionStorage.getItem('reviewAnswers')   || '{}');
let showWrong = false;

function normalizeKey(k){
  if(!k && k !== 0) return '';
  k = String(k).trim();
  const m = k.match(/([A-Z])/i);
  if(m) return m[1].toUpperCase();
  // fallback: first non-space char
  return k.charAt(0).toUpperCase();
}

/** å°† q.options è§„èŒƒä¸º [{key,text}, ...]ï¼Œå…¼å®¹å­—ç¬¦ä¸²å½¢å¼æˆ–å¯¹è±¡å½¢å¼ */
function normalizeOptions(q){
  if(!q || !q.options) return [];
  return q.options.map(o=>{
    if(typeof o === 'string'){
      const m = o.match(/^([A-D])[\.\ã€\s]?(.*)$/i);
      if(m) return { key: m[1].toUpperCase(), text: m[2].trim() || '' };
      // å¦‚æœæ²¡æœ‰ A. å‰ç¼€ï¼Œå°è¯•å–é¦–å­—æ¯ä½œä¸º keyï¼ˆå¤‡ç”¨ï¼‰
      const fallbackKey = (o.trim().charAt(0) || '').toUpperCase();
      return { key: /[A-Z]/i.test(fallbackKey) ? fallbackKey : '', text: o.trim() };
    } else if(typeof o === 'object'){
      const key = (o.key || o.k || '').toString().trim().toUpperCase();
      const text = (o.text || o.label || o.value || '').toString().trim();
      return { key: key, text: text || '' };
    } else {
      return { key: '', text: String(o) };
    }
  });
}

/** åœ¨é€‰é¡¹æ•°ç»„ä¸­æ‰¾æ–‡æœ¬ï¼škeyå¯èƒ½æ˜¯'A'ï¼Œä¹Ÿå¯èƒ½æ˜¯å®Œæ•´ç­”æ¡ˆæ–‡æœ¬ */
function findOptionText(q, key){
  const opts = normalizeOptions(q);
  if(!key) return '';
  const k = normalizeKey(key);
  const found = opts.find(o => o.key === k);
  if(found) return `${found.key}. ${found.text}`;
  // é€€è€Œæ±‚å…¶æ¬¡ï¼šè‹¥ q.options åŸä¸ºçº¯æ–‡æœ¬ä¸”æ²¡æœ‰å‰ç¼€ï¼Œå°è¯•åŒ¹é…åŒ…å« key çš„é‚£ä¸€é¡¹
  const found2 = opts.find(o => o.text && o.text.indexOf(String(key).replace(/^[A-Z]\W*/i,'').trim()) !== -1);
  if(found2) return `${found2.key ? found2.key + '. ' : ''}${found2.text}`;
  return key; // æœ€åè¿”å›åŸå§‹ key
}

function renderReview(){
  const box = document.getElementById('review-box');
  box.innerHTML = '';

  if(!questions || questions.length === 0){
    document.getElementById('rev-total').textContent = 0;
    document.getElementById('rev-correct').textContent = 0;
    document.getElementById('rev-rate').textContent = 0;
    box.innerHTML = '<div class="no-data">æœªæ‰¾åˆ°å›æ”¾æ•°æ®ï¼Œè¯·å…ˆåœ¨ç­”é¢˜é¡µæäº¤å¹¶è·³è½¬åˆ°â€œæŸ¥çœ‹è§£æâ€ã€‚</div>';
    disableButtons(true);
    return;
  }

  disableButtons(false);

  // ç»Ÿè®¡æ€»æ­£ç¡®ï¼ˆå…¨éƒ¨é¢˜ç›®ï¼‰
  let totalCorrect = 0;
  questions.forEach(q => {
    const userKey = normalizeKey(answers[q.id]);
    const answerKey = normalizeKey(q.answer);
    if(userKey && answerKey && userKey === answerKey) totalCorrect++;
  });

  // æ¸²æŸ“ï¼ˆå¯æ ¹æ® showWrong è¿‡æ»¤ï¼‰
  questions.forEach(q => {
    const userRaw = answers[q.id] || '';
    const userKey = normalizeKey(userRaw);
    const answerKey = normalizeKey(q.answer);
    const ok = userKey && answerKey && userKey === answerKey;

    if(showWrong && ok) return; // åªçœ‹é”™é¢˜æ—¶ï¼Œè·³è¿‡å¯¹çš„

    const opts = normalizeOptions(q);
    const optListHtml = opts.map(o=>{
      const classes = [];
      if(o.key && o.key === answerKey) classes.push('correct');
      if(o.key && o.key === userKey) classes.push('selected');
      return `<li class="${classes.join(' ')}">${o.key ? o.key + '. ' : ''}${escapeHtml(o.text)}</li>`;
    }).join('');

    // å¦‚æœæ²¡æœ‰æ ‡å‡†åŒ–é€‰é¡¹ï¼Œå°è¯•æŠŠ q.optionsï¼ˆåŸå§‹ï¼‰æ˜¾ç¤ºä¸ºç®€å•è¡Œ
    const fallbackOptionsHtml = (!opts.length && Array.isArray(q.options)) ? q.options.map(s=>`<li>${escapeHtml(String(s))}</li>`).join('') : '';

    const userShow = userRaw ? findOptionText(q, userRaw) : 'æœªä½œç­”';
    const correctShow = findOptionText(q, q.answer) || (q.answer || '');

    const card = document.createElement('div');
    card.className = 'review-card ' + (ok ? '' : 'wrong');
    card.innerHTML = `
      <h4>${q.number}. ${escapeHtml(q.content)}</h4>
      <ul class="options-list">${optListHtml || fallbackOptionsHtml}</ul>
      <div class="your-ans">ä½ çš„ç­”æ¡ˆï¼š<span style="font-weight:600">${escapeHtml(userShow)}</span> ${ok ? '<span style="color:#28a745;margin-left:8px">âœ“ æ­£ç¡®</span>' : ''}</div>
      ${ok ? '' : `<div class="your-ans" style="color:#dc3545">æ­£ç¡®ç­”æ¡ˆï¼š<strong>${escapeHtml(correctShow)}</strong></div>`}
      <div class="exp">è§£æï¼š${escapeHtml(q.explanation || 'æ— ')}</div>
    `;
    box.appendChild(card);
  });

  document.getElementById('rev-total').textContent  = questions.length;
  document.getElementById('rev-correct').textContent= totalCorrect;
  document.getElementById('rev-rate').textContent   = questions.length ? Math.round(totalCorrect/questions.length*100) : 0;

  updateWrongBtnText();
}

/** åˆ‡æ¢â€œåªçœ‹é”™é¢˜â€ */
function toggleWrong(){
  showWrong = !showWrong;
  renderReview();
}

function updateWrongBtnText(){
  const btn = document.getElementById('btn-wrong');
  btn.textContent = showWrong ? 'æ˜¾ç¤ºå…¨éƒ¨' : 'åªçœ‹é”™é¢˜';
}

/** å¯¼å‡ºå½“å‰æ˜¾ç¤ºçš„ï¼ˆè‹¥ showWrong åˆ™åªå¯¼å‡ºé”™é¢˜ï¼Œå¦åˆ™å¯¼å‡ºå…¨éƒ¨ï¼‰ */
function exportReview(){
  if(!questions || questions.length === 0) return alert('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡º');

  const toExport = questions.filter(q=>{
    const userKey = normalizeKey(answers[q.id]);
    const answerKey = normalizeKey(q.answer);
    const ok = userKey && answerKey && userKey === answerKey;
    return showWrong ? !ok : true;
  });

  const lines = toExport.map(q=>{
    const opts = normalizeOptions(q);
    const optsText = opts.length ? opts.map(o=>`${o.key ? o.key + '. ' : ''}${o.text}`).join('\n') :
      (Array.isArray(q.options) ? q.options.join('\n') : '');
    const userRaw = answers[q.id] || 'æœªä½œç­”';
    const userShow = userRaw ? findOptionText(q, userRaw) : 'æœªä½œç­”';
    const correctShow = findOptionText(q, q.answer) || (q.answer||'');
    return `#é¢˜ç›®${q.number}\n##é¢˜ç›®å†…å®¹\n${q.content}\n##é€‰é¡¹\n${optsText}\n##ä½ çš„ç­”æ¡ˆ\n${userShow}\n##æ­£ç¡®ç­”æ¡ˆ\n${correctShow}\n##è§£æ\n${q.explanation || ''}`;
  });

  const blob = new Blob([lines.join('\n\n')], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'review.txt'; a.click();
  URL.revokeObjectURL(url);
}

/** ç¦ç”¨/å¯ç”¨æŒ‰é’® */
function disableButtons(dis){
  document.getElementById('btn-wrong').disabled = dis;
  document.getElementById('btn-export').disabled = dis;
  document.getElementById('btn-back').disabled = false; // ä¸€ç›´å…è®¸è¿”å›
}

/** ç®€å•çš„ HTML è½¬ä¹‰ï¼ˆé¿å…æ³¨å…¥ï¼‰ */
function escapeHtml(s){
  if(s === null || s === undefined) return '';
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

// åˆå§‹æ¸²æŸ“
renderReview();
</script>
</body>
</html>
